{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'paginainicial.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <aside class="sidebar">
    <div class="user-info">
      <img src="{% static 'img/user.png' %}" alt="Usu√°rio" class="user-avatar-small">
      <h3>Ol√°, {{ user.nome }}!</h3>
      <p class="user-type">{{ user.get_tipo_display }}</p>
    </div>

    <nav class="menu">
      <a href="{% url 'usuarios:meu_perfil' %}" class="menu-item active">Meu Perfil</a>
      <a href="{% url 'corrida:lista_corridas' %}" class="menu-item">Minhas Viagens</a>

      {% if user.tipo_usuario == 'motorista' %}
        <a href="{% url 'corrida:cadastrar_corrida' %}" class="menu-item">Cadastrar Corrida</a>
        <a href="#" class="menu-item">Corridas Ativas</a>
        <a href="#" class="menu-item">Meus Ganhos</a>
      {% else %}
        <a href="#" class="menu-item">Procurar Motorista</a>
        <a href="#" class="menu-item">Motoristas Favoritos</a>
      {% endif %}
      <a href="{% url 'usuarios:logout' %}" class="menu-item logout">üö™ Sair</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="header-banner">
      <h1 id="greeting-message"></h1>
      <p>Pronto para sua pr√≥xima viagem?</p>
    </div>

    <button onclick="toggleDarkMode()" class="action-btn" style="position:absolute;top:15px;right:15px;">üåô</button>

    <div class="map-and-actions">
        <div id="map"></div>
        <div class="action-card">
            {% if user.tipo_usuario == 'motorista' %}
            <h2>Voc√™ est√° online?</h2>
            <p>Altere seu status para aceitar novas corridas.</p>
            <button class="action-btn start">Ficar Online</button>
            {% else %}
            <h2>Encontre seu motorista</h2>
            <p>Inicie sua busca agora e encontre a melhor carona!</p>
            <button class="action-btn search">Procurar Carona</button>
            {% endif %}
        </div>
    </div>

    <section class="safety-tips card">
      <h3>Dicas de Seguran√ßa <span class="icon">üõ°Ô∏è</span></h3>
      <ul>
        <li>Verifique o nome e a placa do motorista antes de entrar no carro.</li>
        <li>Compartilhe sua viagem com amigos ou familiares.</li>
        <li>Sente-se no banco traseiro em corridas individuais.</li>
        <li>Evite informar dados pessoais ao motorista.</li>
        <li>Em caso de emerg√™ncia, use o bot√£o de ajuda no aplicativo.</li>
      </ul>
    </section>
  </main>
</div>

<script>
// ====================== SAUDA√á√ÉO COM EMOJI ======================
function getGreeting() {
  const hour = new Date().getHours();
  let greeting, emoji;
  if (hour < 12) { greeting = "Bom dia"; emoji = "‚òÄÔ∏è"; }
  else if (hour < 18) { greeting = "Boa tarde"; emoji = "üå§Ô∏è"; }
  else { greeting = "Boa noite"; emoji = "üåô"; }
  document.getElementById('greeting-message').textContent = `${emoji} ${greeting}, {{ user.nome }}!`;
}

// ====================== RELOGIO AO LADO DA SAUDA√á√ÉO ======================
function updateClock() {
  const now = new Date();
  const time = now.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
  const greetingEl = document.getElementById('greeting-message');
  if (!greetingEl.querySelector("span")) {
    const span = document.createElement("span");
    span.style.fontSize = "16px";
    span.textContent = ` üïí ${time}`;
    greetingEl.appendChild(span);
  } else {
    greetingEl.querySelector("span").textContent = ` üïí ${time}`;
  }
}
setInterval(updateClock, 60000);

// ====================== MAPA E LOCALIZA√á√ÉO ======================
function initMap() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async function(position) {
      const userLocation = [position.coords.latitude, position.coords.longitude];
      const map = L.map('map').setView(userLocation, 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.marker(userLocation).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();

      showWeather(userLocation[0], userLocation[1]);
      showAddress(userLocation[0], userLocation[1]);
    }, function(error) {
      console.error("Erro de geolocaliza√ß√£o: ", error);
      alert("N√£o foi poss√≠vel obter sua localiza√ß√£o. Verifique as permiss√µes do navegador.");
      const defaultLocation = [-23.5505, -46.6333];
      const map = L.map('map').setView(defaultLocation, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker(defaultLocation).addTo(map).bindPopup("Localiza√ß√£o padr√£o");
    });
  } else {
    alert("Geolocaliza√ß√£o n√£o suportada pelo seu navegador.");
  }
}

// ====================== CLIMA ATUAL ======================
async function showWeather(lat, lon) {
  try {
    const apiKey = "SUA_API_KEY_AQUI"; // Pegue uma chave gratuita em openweathermap.org
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=pt_br&appid=${apiKey}`);
    const data = await res.json();
    const temp = Math.round(data.main.temp);
    const desc = data.weather[0].description;
    const el = document.createElement("div");
    el.className = "weather-info";
    el.innerHTML = `üå§Ô∏è ${temp}¬∞C - ${desc}`;
    document.querySelector(".header-banner").appendChild(el);
  } catch (err) {
    console.log("Erro ao obter clima:", err);
  }
}

// ====================== ENDERE√áO APROXIMADO ======================
async function showAddress(lat, lon) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
  const data = await res.json();
  const city = data.address.city || data.address.town || data.address.village || "local desconhecido";
  const el = document.createElement("p");
  el.textContent = `üìç Localiza√ß√£o aproximada: ${city}`;
  document.querySelector(".header-banner").appendChild(el);
}

// ====================== MODO ESCURO ======================
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
}

// ====================== NOTIFICA√á√ÉO DE NOVAS CORRIDAS ======================
function showNotification(msg) {
  const box = document.createElement("div");
  box.className = "popup-notification";
  box.textContent = msg;
  document.body.appendChild(box);
  setTimeout(() => box.remove(), 4000);
}

// ====================== CHAMADA PRINCIPAL ======================
window.onload = function() {
  getGreeting();
  updateClock();
  initMap();

  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark-mode");
  }

  setTimeout(() => showNotification("üöó H√° novas corridas dispon√≠veis na sua √°rea!"), 5000);
};
</script>

<style>
/* ============ ANIMA√á√ÉO HEADER ============ */
.header-banner h1, .header-banner p {
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeInMove 1s forwards;
}
@keyframes fadeInMove {
  to { opacity: 1; transform: translateY(0); }
}

/* ============ MODO ESCURO ============ */
body.dark-mode {
  background: #121212;
  color: #eee;
}
body.dark-mode .sidebar, body.dark-mode .main-content {
  background: #1e1e1e !important;
}

/* ============ NOTIFICA√á√ÉO ============ */
.popup-notification {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  animation: slideIn 0.4s ease;
}
@keyframes slideIn {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* ============ CLIMA E LOCALIZA√á√ÉO ============ */
.weather-info {
  font-weight: 500;
  margin-top: 8px;
}
</style>

{% endblock %}
