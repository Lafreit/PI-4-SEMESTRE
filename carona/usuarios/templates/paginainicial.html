
{% load static %}

{% block extra_head %}

<link rel="stylesheet" href="{% static 'paginainicial.css' %}">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

{% endblock %}

{% block content %}
<title>Carona | Pagina Inicial</title>
<div class="dashboard-container">
    
   <nav class="top-navbar" id="mainNavbar">

    <div class="logo-area">
        <img src="{% static 'img/logo.png' %}" alt="Logo" class="logo-img">
    </div>

    <div class="menu">
        <a href="{% url 'usuarios:pagina_inicial' %}" class="menu-item">In√≠cio</a>
        <a href="{% url 'usuarios:meu_perfil' %}" class="menu-item active">Meu Perfil</a>
        <a href="{% url 'corrida:lista_corridas' %}" class="menu-item">Minhas Viagens</a>
        <a href="{% url 'notificacao:lista' %}" class="menu-item">Notifica√ß√µes</a>
        <a href="{% url 'pagamentos:carteira' %}" class="menu-item">Carteira</a>
        <a href="#" class="menu-item" onclick="openTabFromNavbar(event, 'dicas-usuario')">Dicas de Usu√°rio</a>
    </div>

    <div class="user-and-logout">

        <div class="user-info-navbar">
            <button onclick="toggleDarkMode()" id="themeToggleBtn" class="action-btn mode-toggle-btn">
        ‚òÄÔ∏è
    </button>
            <img src="{% static 'img/imgusu.png' %}" alt="Usu√°rio" class="user-avatar-small">
            <span>{{ user.nome }}</span>
        </div>

        <a href="{% url 'usuarios:logout' %}" class="action-btn logout-btn red-btn">Sair</a>
    </div>

</nav>


    <main class="main-content">
        <div class="header-banner">
            <h1 id="greeting-message"></h1>
            <p>Pronto para sua pr√≥xima viagem?</p>
            
            <div id="weather-and-location"></div>

            <div class="scroll-indicator">
                <span class="arrow-down">‚Üì</span> Role para ver o mapa e mais
            </div>
        </div>

        <div class="map-and-actions">
            <div id="map"></div>
            <div class="action-card">
                {% if user.tipo_usuario == 'motorista' %}
                <h2>Cadastre Corridas</h2>
                <p>Cadastre suas corridas, encontre Passageiros.</p>
                <a href="{% url 'corrida:cadastrar_corrida' %}" class="action-btn start">Cadastrar Corrida</a>
                {% else %}
                <h2>Encontre seu motorista</h2>
                <p>Inicie sua busca agora e encontre a melhor carona!</p>
                <a href="{% url 'corrida:buscar_corridas' %}" class="action-btn search">Procurar Carona</a>
                {% endif %}
            </div>
        </div>

        <div class="modular-sections">
            <div class="tab-menu">
                
                {% if user.tipo_usuario == 'motorista' %}
                    <button class="tab-button active" onclick="openTab(event, 'driver-tools')">
                        üõ†Ô∏è Ferramentas do Motorista
                    </button>
                {% else %}
                    <button class="tab-button active" onclick="openTab(event, 'passenger-tools')">
                        üîß Ferramentas do Passageiro
                    </button>
                {% endif %}

                <button class="tab-button" onclick="openTab(event, 'dicas-seguranca')">
                    üõ°Ô∏è Dicas de Seguran√ßa
                </button>
                
                <button class="tab-button" onclick="openTab(event, 'help-center')">
                    ‚ùì Central de D√∫vidas
                </button>

                <button class="tab-button hidden-tab" id="dicas-usuario-btn" onclick="openTab(event, 'dicas-usuario')"></button>

                <button class="tab-button vip" onclick="openTab(event, 'vip-plan')">
                    üëë Plano Carona VIP
                </button>
            </div>

            <div class="tab-content-container">
                
                {% if user.tipo_usuario == 'motorista' %}
                    <div id="driver-tools" class="tab-content active">
                        <h3>Ferramentas de Gerenciamento</h3>
                        <ul>
                            <li><b>Corridas Ativas:</b> Veja as corridas que voc√™ est√° realizando no momento.</li>
                            <li><b>Meus Ganhos:</b> Acompanhe seu hist√≥rico de faturamento e extrato de pagamentos.</li>
                            <li><b>Alterar Status:</b> Use o bot√£o "Ficar Online" no card ao lado para come√ßar a aceitar pedidos.</li>
                            <li><b>Relat√≥rios:</b> Acesse relat√≥rios mensais de desempenho e avalia√ß√µes.</li>
                        </ul>
                    </div>
                {% else %}
                    <div id="passenger-tools" class="tab-content active">
                        <h3>Gerenciamento e Busca de Caronas</h3>
                        <p>Use o link abaixo para acessar a busca avan√ßada por viagens.</p>
                        <p>Voc√™ tamb√©m pode acompanhar suas viagens agendadas e ver as avalia√ß√µes de motoristas favoritos.</p>
                        <a href="{% url 'corrida:buscar_corridas' %}" class="action-btn start" style="padding: 0.7rem 1.2rem; margin-top: 10px;">Procurar Carona Agora</a>
                        <ul>
                            <li><b>Viagens Agendadas:</b> Consulte o status e os detalhes das suas reservas.</li>
                            <li><b>Avalia√ß√µes:</b> Veja as notas e coment√°rios dos seus motoristas preferidos.</li>
                        </ul>
                    </div>
                {% endif %}

                <div id="dicas-usuario" class="tab-content">
                    <h3>üëç Dicas para uma Experi√™ncia Perfeita</h3>
                    <p>Maximize sua experi√™ncia no Carona F√°cil, seja voc√™ um motorista ou passageiro, seguindo estas recomenda√ß√µes:</p>
                    <ul>
                        <li><b>Sempre Confirme:</b> Motoristas, liguem para o passageiro para confirmar o local exato antes de iniciar a rota.</li>
                        <li><b>Mantenha seu Perfil Atualizado:</b> Uma boa foto e informa√ß√µes completas aumentam a confian√ßa.</li>
                        <li><b>Seja Pontual:</b> A pontualidade √© essencial para o respeito m√∫tuo e uma boa avalia√ß√£o.</li>
                        <li><b>Use o Chat:</b> Para d√∫vidas r√°pidas sobre a viagem, use o chat do aplicativo para manter o hist√≥rico.</li>
                        <li><b>D√™ Feedback:</b> Avalie sua viagem para ajudar a comunidade a manter a qualidade.</li>
                    </ul>
                    <a href="{% url 'usuarios:meu_perfil' %}" class="action-btn start" style="padding: 0.7rem 1.2rem; margin-top: 10px;">Ver Meu Perfil para Atualizar</a>
                </div>
                <div id="dicas-seguranca" class="tab-content">
                    <h3>Sua Seguran√ßa √© Nossa Prioridade</h3>
                    <p>Leia as nossas dicas para garantir que todas as suas viagens sejam tranquilas e seguras. Em caso de emerg√™ncia, use o bot√£o de suporte imediato.</p>
                    <ul>
                        <li><b>Compartilhe a Viagem:</b> Sempre use a fun√ß√£o de compartilhamento de rota com amigos ou familiares.</li>
                        <li><b>Verifique o Motorista/Carro:</b> Confirme a placa, modelo do ve√≠culo e nome do motorista antes de entrar.</li>
                        <li><b>Comunica√ß√£o:</b> Mantenha a comunica√ß√£o dentro do app e evite compartilhar informa√ß√µes pessoais desnecess√°rias.</li>
                        <li><b>Relate Problemas:</b> N√£o hesite em usar a Central de D√∫vidas ou o Suporte ao Cliente para relatar qualquer comportamento estranho.</li>
                    </ul>
                    <button class="action-btn start" style="padding: 0.7rem 1.2rem; margin-top: 10px;">Suporte Imediato üö®</button>
                </div>
                
                <div id="help-center" class="tab-content">
                    <h3>Central de D√∫vidas e Suporte</h3>
                    <p>Encontre respostas r√°pidas para as perguntas mais frequentes sobre o aplicativo, pagamentos e mais.</p>
                    <ul>
                        <li><b>D√∫vidas Comuns:</b> Como funciona o cancelamento? Como √© calculada a tarifa?</li>
                        <li><b>Suporte ao Cliente:</b> Fale com um de nossos atendentes.</li>
                        <li><b>Dicas de Seguran√ßa:</b> Acesse o guia de seguran√ßa na aba ao lado para mais informa√ß√µes.</li>
                    </ul>
                    <a href="#" class="action-btn start" style="padding: 0.7rem 1.2rem; margin-top: 10px;">Acessar Central de Ajuda Completa</a>
                </div>

                <div id="vip-plan" class="tab-content vip">
                    <h3>Benef√≠cios Exclusivos do Carona VIP</h3>
                    <p>Assine o plano VIP e tenha acesso a benef√≠cios exclusivos, garantindo a melhor experi√™ncia em todas as suas viagens:</p>
                    <ul>
                        <li>Descontos maiores e tarifas reduzidas.</li>
                        <li>Prioridade na busca e aceita√ß√£o de corridas.</li>
                        <li>Suporte ao Cliente 24h dedicado.</li>
                        <li>Acesso a eventos e promo√ß√µes exclusivas.</li>
                    </ul>
                    <button class="action-btn start" style="margin-top:10px;">Assinar VIP Agora</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Vari√°vel global para o caminho base das imagens est√°ticas do Django
const STATIC_IMG_BASE = "{% static 'img/' %}";

// Vari√°veis para armazenar a sauda√ß√£o e o emoji atuais
let currentGreeting = "";
let currentEmoji = "";
// Vari√°vel global para armazenar o nome do arquivo de imagem atual
let currentImageFile = "";

// ====================== L√ìGICA DE SAUDA√á√ÉO E BACKGROUND DIN√ÇMICO ======================
function getGreetingAndBackground(isToggle = false) {
    const hour = new Date().getHours();
    
    // 1. Determina o hor√°rio, a sauda√ß√£o e o nome do arquivo de imagem padr√£o
    if (hour >= 6 && hour < 12) {
        currentGreeting = "Bom dia";
        currentEmoji = "";
        currentImageFile = "imgsol.png";
    } else if (hour >= 12 && hour < 18) {
        currentGreeting = "Boa tarde";
        currentEmoji = "";
        currentImageFile = "imgtarde.png";
    } else {
        currentGreeting = "Boa noite";
        currentEmoji = "";
        currentImageFile = "imglua.png"; // Imagem com estrelas e as duas luas grandes nas laterais
    }

    // 2. Define o background din√¢mico
    const banner = document.querySelector('.header-banner');
    const darkModeActive = document.body.classList.contains("dark-mode");
    
    let finalImageUrl = STATIC_IMG_BASE + currentImageFile;
    
    // L√≥gica para mostrar a lua grande SOMENTE se for noite E Dark Mode estiver ativo
    if (currentImageFile === "imglua.png" && darkModeActive) {
        // Quando o Dark Mode est√° ativo na noite, ajustamos para mostrar a lua grande
        banner.style.backgroundPosition = 'center top';
    } else if (currentImageFile === "imglua.png" && !darkModeActive) {
        
        banner.style.backgroundPosition = 'center center';
    } else {
        // Para dia e tarde, a posi√ß√£o pode ser 'cover' normal
        banner.style.backgroundPosition = 'center center';
    }

    // Adiciona um overlay escuro semi-transparente para melhor contraste do texto
    const gradientOverlay = 'linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.2)),';
    banner.style.backgroundImage = `${gradientOverlay} url('${finalImageUrl}')`;
    
    // Atualiza o texto e a hora
    updateClock();
}

// ====================== OUTRAS FUN√á√ïES JS ======================

// C√ìDIGO DO SMART HEADER (ESCONDE/REVELA)
let lastScrollTop = 0;
const navbar = document.getElementById('mainNavbar');
let navbarHeight = navbar ? navbar.offsetHeight : 0;

window.addEventListener('scroll', function() {
    if (!navbar) return;
    let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
    if (currentScroll > lastScrollTop && currentScroll > navbarHeight) {
        navbar.classList.add('hidden');
    } else if (currentScroll < lastScrollTop || currentScroll <= navbarHeight) {
        navbar.classList.remove('hidden');
    }
    lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}, false);

// EXPANDIR/RECOLHER SE√á√ïES (TABS)
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    
    // Ativa a aba
    document.getElementById(tabName).classList.add("active");
    // Ativa o bot√£o (se existir, para o caso do bot√£o escondido)
    const tabButton = evt.currentTarget;
    if (tabButton) {
         tabButton.classList.add("active");
    }

    // Rola a tela para baixo para mostrar a se√ß√£o modular
    document.getElementById(tabName).scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// NOVA FUN√á√ÉO: Lida com o clique na Navbar e foca o bot√£o de aba correspondente
function openTabFromNavbar(evt, tabName) {
    evt.preventDefault();
    // 1. Pega o bot√£o de aba escondido
    const targetButton = document.getElementById(tabName + '-btn');
    
    if (targetButton) {
        // 2. Chama a fun√ß√£o openTab, simulando o evento no bot√£o
        openTab({ currentTarget: targetButton }, tabName);
    } else {
        // Caso o bot√£o esteja no menu de abas e seja vis√≠vel (n√£o tem "-btn")
        const visibleButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
         if (visibleButton) {
             openTab({ currentTarget: visibleButton }, tabName);
        }
    }
}


// REL√ìGIO (Atualiza o H1 com o emoji, a sauda√ß√£o e a hora)
function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
    const greetingEl = document.getElementById('greeting-message');

    // Monta o H1 com o emoji, sauda√ß√£o, nome do usu√°rio e a hora
    greetingEl.innerHTML = `
        ${currentEmoji} ${currentGreeting}, {{ user.nome }}!
        <span class="clock-display"> ${time}</span>
    `;
}
// Atualiza a cada 60 segundos
setInterval(updateClock, 60000);

// MAPA E LOCALIZA√á√ÉO (LEAFLET)
function initMap() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(position) {
            const userLocation = [position.coords.latitude, position.coords.longitude];
            const map = L.map('map').setView(userLocation, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.marker(userLocation).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
            
            showAddress(userLocation[0], userLocation[1]);
        }, function(error) {
            console.error("Erro de geolocaliza√ß√£o: ", error);
            const defaultLocation = [-23.5505, -46.6333];
            const map = L.map('map').setView(defaultLocation, 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker(defaultLocation).addTo(map).bindPopup("Localiza√ß√£o padr√£o");
        });
    } else {
        console.warn("Geolocaliza√ß√£o n√£o suportada.");
    }
}

// Fun√ß√£o para reverter geocodifica√ß√£o
async function showAddress(lat, lon) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const data = await res.json();
        const city = data.address.city || data.address.town || data.address.village || "Local Desconhecido";
        
        const infoContainer = document.getElementById("weather-and-location");
        if (infoContainer) {
            infoContainer.innerHTML = `<p class="location-info">üìç Localiza√ß√£o aproximada: ${city}</p>`;
        }
    } catch (err) {
        console.warn("Erro ao obter endere√ßo:", err);
    }
}
function updateThemeIcon() {
    const btn = document.getElementById("themeToggleBtn");
    const darkModeActive = document.body.classList.contains("dark-mode");

    // Se estiver no modo escuro ‚Üí mostra o sol
    btn.textContent = darkModeActive ? "üåô" : "‚òÄÔ∏è";
}
// MODO ESCURO
function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    
    // salva prefer√™ncia
    const darkModeActive = document.body.classList.contains("dark-mode");
    localStorage.setItem("darkMode", darkModeActive);

    // atualiza √≠cone do bot√£o
    updateThemeIcon();

    // atualiza o background conforme modo
    getGreetingAndBackground(true);
}

// INICIALIZA√á√ÉO
window.onload = function() {
    const navbarElement = document.getElementById('mainNavbar');
    if (navbarElement) {
        navbarHeight = navbarElement.offsetHeight;
    }

    // A chamada inicial j√° aplica a prefer√™ncia de dark mode salva
    if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
    }
     updateThemeIcon();   // ‚¨ÖÔ∏è AQUI
    getGreetingAndBackground();
    initMap();
};
</script>

{% endblock %}
