{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'paginainicial.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
/* ======= SINO DE NOTIFICA√á√ïES ======= */
.notif-icon {
  position:absolute;
  top:15px;
  right:70px; /* deixa espa√ßo para o bot√£o üåô */
  font-size:24px;
  cursor:pointer;
  user-select:none;
}

.notif-count {
  background:red;
  color:white;
  font-size:12px;
  padding:2px 6px;
  border-radius:999px;
  margin-left:4px;
  font-weight:bold;
  position:relative;
  top:-8px;
}

/* quando n√£o houver notifica√ß√µes */
.notif-count.zero {
  background:gray;
}

/* √çcone de notifica√ß√µes */
.notif-icon {
  position: absolute;
  top: 15px;
  right: 70px;
  font-size: 24px;
  cursor: pointer;
  text-decoration: none;
  z-index: 9999; /* FICA NA FRENTE */
}

.notif-count {
  background: red;
  color: white;
  padding: 2px 6px;
  border-radius: 50%;
  font-size: 12px;
}


/* Bot√£o de modo escuro */
.theme-btn {
  position: absolute !important;
  top: 15px;
  right: 20px;
  z-index: 9999; /* FICA NA FRENTE */
}


</style>

{% endblock %}

{% block content %}

<div class="dashboard-container">
  <aside class="sidebar">
    <div class="user-info">
      <img src="{% static 'img/user.png' %}" alt="Usu√°rio" class="user-avatar-small">
      <h3>Ol√°, {{ user.nome }}!</h3>
      <p class="user-type">{{ user.get_tipo_display }}</p>
    </div>

    <nav class="menu">
      <a href="{% url 'usuarios:meu_perfil' %}" class="menu-item active">Meu Perfil</a>
      <a href="#" class="menu-item">Minha Carteira</a>

      {% if user.tipo_usuario == 'motorista' %}
        <a href="{% url 'corrida:cadastrar_corrida' %}" class="menu-item">Cadastrar Carona</a>
        <a href="{% url 'corrida:lista_corridas' %}" class="menu-item">Minhas Caronas</a>
        <a href="#" class="menu-item">Meus Veiculos</a>
      {% elif user.tipo_usuario == 'passageiro'%}
        <a href="{% url 'corrida:buscar_corridas' %}" class="menu-item">Buscar Carona</a>
      {% endif %}

      {% if user.tipo_usuario == 'admin' %}
        <a href="{% url 'corrida:cadastrar_corrida' %}" class="menu-item">Cadastrar Carona</a>
        <a href="{% url 'corrida:lista_corridas' %}" class="menu-item">Minhas Caronas</a>
        <a href="{% url 'corrida:buscar_corridas' %}" class="menu-item">Buscar Carona</a>
        <a href="#" class="menu-item">Meus Veiculos</a>
        <a href="{% url 'admin:index' %}" class="menu-item">Painel Admin</a>
      {% endif %}
      <a href="{% url 'usuarios:logout' %}" class="menu-item logout">Sair</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="header-banner">
      <!-- üîî √çCONE DE NOTIFICA√á√ïES -->
      <a href="{% url 'notificacao:lista' %}" class="notif-icon">
        üîî <span id="notif-count" class="notif-count zero">0</span>
      </a>

      <!-- üåô BOT√ÉO DARK MODE -->
      <button onclick="toggleDarkMode()" class="action-btn theme-btn">üåô</button>

      <h1 id="greeting-message"></h1>
      <p>Pronto para sua pr√≥xima viagem?</p>
    </div>

    <div class="map-and-actions">
        <div id="map"></div>
        <div class="action-card">
            {% if user.tipo_usuario == 'motorista' or user.tipo_usuario == 'admin' %}
            <h2>Voc√™ est√° online?</h2>
            <p>Altere seu status para aceitar novas corridas.</p>
            <button class="action-btn start">Ficar Online</button>
            {% elif user.tipo_usuario == 'passageiro' or user.tipo_usuario == 'admin'  %}
            <h2>Encontre seu motorista</h2>
            <p>Inicie sua busca agora e encontre a melhor carona!</p>
            <button class="action-btn search">Procurar Carona</button>
            {% endif %}
        </div>
    </div>

    <section class="safety-tips card">
      <h3>Dicas de Seguran√ßa <span class="icon">üõ°Ô∏è</span></h3>
      <ul>
        <li>Verifique o nome e a placa do motorista antes de entrar no carro.</li>
        <li>Compartilhe sua viagem com amigos ou familiares.</li>
        <li>Sente-se no banco traseiro em corridas individuais.</li>
        <li>Evite informar dados pessoais ao motorista.</li>
        <li>Em caso de emerg√™ncia, use o bot√£o de ajuda no aplicativo.</li>
      </ul>
    </section>
  </main>
</div>

<script>
// ====================== Atualizar contador do sino ======================
async function atualizarSino() {
  try {
    const res = await fetch("/notificacoes/api/contagem/?_=" + Date.now());
    if (!res.ok) return;
    const data = await res.json();

    const el = document.getElementById("notif-count");
    el.textContent = data.unread;

    if (data.unread > 0) {
      el.classList.remove("zero");
    } else {
      el.classList.add("zero");
    }
  } catch (e) {}
}

setInterval(atualizarSino, 15000);
document.addEventListener("DOMContentLoaded", atualizarSino);

// (resto DO SEU SCRIPT PERMANECE IGUAL)

// ====================== SAUDA√á√ÉO COM EMOJI ======================
function getGreeting() {
  const hour = new Date().getHours();
  let greeting, emoji;
  if (hour < 12) { greeting = "Bom dia"; emoji = "‚òÄÔ∏è"; }
  else if (hour < 18) { greeting = "Boa tarde"; emoji = "üå§Ô∏è"; }
  else { greeting = "Boa noite"; emoji = "üåô"; }
  document.getElementById('greeting-message').textContent = `${emoji} ${greeting}, {{ user.nome }}!`;
}

// ====================== RELOGIO ======================
function updateClock() {
  const now = new Date();
  const time = now.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
  const greetingEl = document.getElementById('greeting-message');
  if (!greetingEl.querySelector("span")) {
    const span = document.createElement("span");
    span.style.fontSize = "16px";
    span.textContent = ` üïí ${time}`;
    greetingEl.appendChild(span);
  } else {
    greetingEl.querySelector("span").textContent = ` üïí ${time}`;
  }
}
setInterval(updateClock, 60000);

// ====================== MAPA ======================
function initMap() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async function(position) {
      const userLocation = [position.coords.latitude, position.coords.longitude];
      const map = L.map('map').setView(userLocation, 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.marker(userLocation).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();

      showWeather(userLocation[0], userLocation[1]);
      showAddress(userLocation[0], userLocation[1]);
    }, function(error) {
      // ...
    });
  }
}

// ====================== SHOW WEATHER ======================
async function showWeather(lat, lon) {
  try {
    const apiKey = ORS_API_KEY;
    const res = await fetch(`https://api.openweathermap.org/...`);
    // ...
  } catch (err) {}
}

// ====================== ENDERE√áO ======================
async function showAddress(lat, lon) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
  const data = await res.json();
  const city = data.address.city || data.address.town || data.address.village || "local desconhecido";
  const el = document.createElement("p");
  el.textContent = `üìç Localiza√ß√£o aproximada: ${city}`;
  document.querySelector(".header-banner").appendChild(el);
}

// ====================== MODO ESCURO ======================
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
}

// ====================== NOTIFICA√á√ÉO POPUP ======================
function showNotification(msg) {
  const box = document.createElement("div");
  box.className = "popup-notification";
  box.textContent = msg;
  document.body.appendChild(box);
  setTimeout(() => box.remove(), 4000);
}

// ====================== CHAMADA PRINCIPAL ======================
window.onload = function() {
  getGreeting();
  updateClock();
  initMap();

  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark-mode");
  }

  setTimeout(() => showNotification("üöó H√° novas corridas dispon√≠veis na sua √°rea!"), 5000);
};
</script>

{% endblock %}
