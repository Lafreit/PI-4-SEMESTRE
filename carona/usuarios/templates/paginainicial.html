{% extends "base.html" %}

{% load static %}

{% block extra_head %}

<link rel="stylesheet" href="{% static 'paginainicial.css' %}">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">


{% endblock %}

{% block content %}

<div class="dashboard-container">
    
    <nav class="top-navbar" id="mainNavbar">
        
        <!-- LOGO AQUI -->
        <div class="logo-area">
            <img src="{% static 'img/logo.png' %}" alt="Logo Carona F√°cil" class="logo-img">
        </div>

        <div class="menu">
            <a href="{% url 'usuarios:meu_perfil' %}" class="menu-item active">Meu Perfil</a>
            <a href="{% url 'corrida:lista_corridas' %}" class="menu-item">Minhas Viagens</a>
            <a href="#" class="menu-item" onclick="openTabFromNavbar(event, 'dicas-usuario')">Dicas de Usu√°rio</a>
        </div>

        <div class="user-and-logout">
            <div class="user-info-navbar">
                <img src="{% static 'img/imgusu.png' %}" alt="Usu√°rio" class="user-avatar-small">
                <span>{{ user.nome }}</span>
            </div>
            <a href="{% url 'usuarios:logout' %}" class="action-btn logout-btn red-btn">Sair</a>
        </div>
    </nav>
    

    <main class="main-content">
        <div class="header-banner">
            <h1 id="greeting-message"></h1>
            <p>Pronto para sua pr√≥xima viagem?</p>
            
            <div id="weather-and-location"></div>

            <button onclick="toggleDarkMode()" class="action-btn mode-toggle-btn">üåô</button>

            <div class="scroll-indicator">
                <span class="arrow-down">‚Üì</span> Role para ver o mapa e mais
            </div>
        </div>

        <div class="map-and-actions">
            <div id="map"></div>
            <div class="action-card">
                {% if user.tipo_usuario == 'motorista' %}
                <h2>Cadastre Corridas</h2>
                <p>Cadastre suas corridas, encontre Passageiros.</p>
                <a href="{% url 'corrida:cadastrar_corrida' %}" class="action-btn start">Cadastrar Corrida</a>
                {% else %}
                <h2>Encontre seu motorista</h2>
                <p>Inicie sua busca agora e encontre a melhor carona!</p>
                <a href="{% url 'corrida:buscar_corridas' %}" class="action-btn search">Procurar Carona</a>
                {% endif %}
            </div>
        </div>

        <div class="modular-sections">
            <div class="tab-menu">
                
                {% if user.tipo_usuario == 'motorista' %}
                    <button class="tab-button active" onclick="openTab(event, 'driver-tools')">
                        üõ†Ô∏è Ferramentas do Motorista
                    </button>
                {% else %}
                    <button class="tab-button active" onclick="openTab(event, 'passenger-tools')">
                        üîß Ferramentas do Passageiro
                    </button>
                {% endif %}

                <button class="tab-button" onclick="openTab(event, 'dicas-seguranca')">
                    üõ°Ô∏è Dicas de Seguran√ßa
                </button>
                
                <button class="tab-button" onclick="openTab(event, 'help-center')">
                    ‚ùì Central de D√∫vidas
                </button>

                <button class="tab-button hidden-tab" id="dicas-usuario-btn" onclick="openTab(event, 'dicas-usuario')"></button>

                <button class="tab-button vip" onclick="openTab(event, 'vip-plan')">
                    üëë Plano Carona VIP
                </button>
            </div>

            <div class="tab-content-container">
                
                {% if user.tipo_usuario == 'motorista' %}
                    <div id="driver-tools" class="tab-content active">
                        <h3>Ferramentas de Gerenciamento</h3>
                        <ul>
                            <li><b>Corridas Ativas:</b> Veja as corridas que voc√™ est√° realizando no momento.</li>
                            <li><b>Meus Ganhos:</b> Acompanhe seu hist√≥rico de faturamento e extrato de pagamentos.</li>
                            <li><b>Alterar Status:</b> Use o bot√£o "Ficar Online" no card ao lado para come√ßar a aceitar pedidos.</li>
                            <li><b>Relat√≥rios:</b> Acesse relat√≥rios mensais de desempenho e avalia√ß√µes.</li>
                        </ul>
                    </div>
                {% else %}
                    <div id="passenger-tools" class="tab-content active">
                        <h3>Gerenciamento e Busca de Caronas</h3>
                        <p>Use o link abaixo para acessar a busca avan√ßada por viagens.</p>
                        <a href="{% url 'corrida:buscar_corridas' %}" class="action-btn start" style="padding: 0.7rem 1.2rem; margin-top: 10px;">Procurar Carona Agora</a>
                    </div>
                {% endif %}

                <div id="dicas-usuario" class="tab-content">
                    <h3>üëç Dicas para uma Experi√™ncia Perfeita</h3>
                    <ul>
                        <li><b>Sempre Confirme:</b> Motoristas devem confirmar o local antes da rota.</li>
                        <li><b>Perfil Atualizado:</b> passa mais confian√ßa.</li>
                        <li><b>Pontualidade:</b> essencial para uma boa experi√™ncia.</li>
                    </ul>
                </div>

                <div id="dicas-seguranca" class="tab-content">
                    <h3>Sua Seguran√ßa √© Nossa Prioridade</h3>
                    <ul>
                        <li><b>Compartilhe a Viagem:</b> com familiares.</li>
                        <li><b>Verifique informa√ß√µes:</b> placa e motorista.</li>
                    </ul>
                </div>
                
                <div id="help-center" class="tab-content">
                    <h3>Central de D√∫vidas</h3>
                    <p>Perguntas frequentes e suporte.</p>
                </div>

                <div id="vip-plan" class="tab-content vip">
                    <h3>Benef√≠cios do Carona VIP</h3>
                    <ul>
                        <li>Descontos.</li>
                        <li>Prioridade.</li>
                        <li>Suporte 24h.</li>
                    </ul>
                </div>

            </div>
        </div>
    </main>
</div>

<script>
const STATIC_IMG_BASE = "{% static 'img/' %}";
let currentGreeting = "";
let currentEmoji = "";
let currentImageFile = "";

/* ------------------ SAUDA√á√ÉO + BACKGROUND ------------------- */
function getGreetingAndBackground(isToggle = false) {
    const hour = new Date().getHours();

    if (hour >= 6 && hour < 12) {
        currentGreeting = "Bom dia";
        currentImageFile = "imgsol.png";
    } else if (hour >= 12 && hour < 18) {
        currentGreeting = "Boa tarde";
        currentImageFile = "imgtarde.png";
    } else {
        currentGreeting = "Boa noite";
        currentImageFile = "imglua.png";
    }

    const banner = document.querySelector('.header-banner');
    const darkModeActive = document.body.classList.contains("dark-mode");

    banner.style.backgroundImage =
        `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.2)), url('${STATIC_IMG_BASE + currentImageFile}')`;

    updateClock();
}

function updateClock() {
    const now = new Date();
    const time = now.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
    document.getElementById('greeting-message').innerHTML =
        `${currentGreeting}, {{ user.nome }}! <span class="clock-display">${time}</span>`;
}
setInterval(updateClock, 60000);

/* ------------------ MAPA ------------------- */
function initMap() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(position) {
            const userLocation = [position.coords.latitude, position.coords.longitude];
            const map = L.map('map').setView(userLocation, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.marker(userLocation).addTo(map).bindPopup("Voc√™ est√° aqui!");
        });
    }
}

/* ------------------ TABS ------------------- */
function openTab(evt, tabName) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));

    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function openTabFromNavbar(evt, tabName) {
    evt.preventDefault();
    const targetButton = document.getElementById(tabName + '-btn');
    openTab({ currentTarget: targetButton }, tabName);
}

/* ------------------ DARK MODE ------------------- */
function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    getGreetingAndBackground(true);
}

/* ------------------ LOAD ------------------- */
window.onload = function() {
    if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
    }
    getGreetingAndBackground();
    initMap();
};
</script>

{% endblock %}
