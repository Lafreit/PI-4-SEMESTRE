{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'paginainicial.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <aside class="sidebar">
    <div class="user-info">
      {# Removido o user-avatar para um estilo mais clean como a landing page #}
      <img src="{% static 'img/user.png' %}" alt="Usu√°rio" class="user-avatar-small"> {# Um √≠cone menor e mais discreto, se quiser manter #}
      <h3>Ol√°, {{ user.nome }}!</h3> {# A sauda√ß√£o principal agora fica no main #}
      <p class="user-type">{{ user.get_tipo_display }}</p>
    </div>

    <nav class="menu">
      <a href="{% url 'usuarios:meu_perfil' %}" class="menu-item active">üë§ Meu Perfil</a>
      <a href="#" class="menu-item">üïì Minhas Viagens</a>
      
      {% if user.tipo_usuario == 'motorista' %}
        <a href="{% url 'corrida:cadastrar_corrida' %}" class="menu-item">üìù Cadastrar Corrida</a>
        <a href="#" class="menu-item">üöó Corridas Ativas</a>
        <a href="#" class="menu-item">üí∞ Meus Ganhos</a>
      {% else %}
        <a href="#" class="menu-item">üß≠ Procurar Motorista</a>
        <a href="#" class="menu-item">‚≠ê Motoristas Favoritos</a>
      {% endif %}
      <a href="{% url 'usuarios:logout' %}" class="menu-item logout">üö™ Sair</a>
    </nav>
  </aside>

  <main class="main-content"> {# Renomeado para main-content para melhor sem√¢ntica #}
    <div class="header-banner">
      <h1 id="greeting-message"></h1> {# Sauda√ß√£o din√¢mica ser√° injetada aqui #}
      <p>Pronto para sua pr√≥xima viagem?</p>
      {# Voc√™ pode adicionar uma imagem de fundo aqui via CSS para um estilo de capa #}
    </div>

    <div class="map-and-actions">
        <div id="map"></div>
        <div class="action-card">
            {% if user.tipo_usuario == 'motorista' %}
            <h2>Voc√™ est√° online?</h2>
            <p>Altere seu status para aceitar novas corridas.</p>
            <button class="action-btn start">Ficar Online</button>
            {% else %}
            <h2>Encontre seu motorista</h2>
            <p>Inicie sua busca agora e encontre a melhor carona!</p>
            <button class="action-btn search">Procurar Carona</button>
            {% endif %}
        </div>
    </div>

    <section class="safety-tips card"> {# Adicionado classe 'card' para estilo #}
      <h3>Dicas de Seguran√ßa <span class="icon">üõ°Ô∏è</span></h3>
      <ul>
        <li>Verifique o nome e a placa do motorista antes de entrar no carro.</li>
        <li>Compartilhe sua viagem com amigos ou familiares.</li>
        <li>Sente-se no banco traseiro em corridas individuais.</li>
        <li>Evite informar dados pessoais ao motorista.</li>
        <li>Em caso de emerg√™ncia, use o bot√£o de ajuda no aplicativo.</li>
      </ul>
    </section>
  </main>
</div>

<script>
function getGreeting() {
  const hour = new Date().getHours();
  let greeting;
  if (hour < 12) {
    greeting = "Bom dia";
  } else if (hour < 18) {
    greeting = "Boa tarde";
  } else {
    greeting = "Boa noite";
  }
  document.getElementById('greeting-message').textContent = `${greeting}, {{ user.nome }}!`;
}

function initMap() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      const userLocation = [
        position.coords.latitude,
        position.coords.longitude
      ];

      const map = L.map('map').setView(userLocation, 14); 

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      L.marker(userLocation)
        .addTo(map)
        .bindPopup("Voc√™ est√° aqui!")
        .openPopup();
        
    }, function(error) {
        console.error("Erro de geolocaliza√ß√£o: ", error); // Para depura√ß√£o
        alert("N√£o foi poss√≠vel obter sua localiza√ß√£o. Verifique as permiss√µes do navegador.");
        
        // Exibe um mapa padr√£o caso a geolocaliza√ß√£o falhe
        const defaultLocation = [-23.5505, -46.6333]; // Ex: S√£o Paulo
        const map = L.map('map').setView(defaultLocation, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.marker(defaultLocation).addTo(map).bindPopup("Localiza√ß√£o padr√£o");
    });
  } else {
    alert("Geolocaliza√ß√£o n√£o suportada pelo seu navegador.");
    // Exibe um mapa padr√£o se a geolocaliza√ß√£o n√£o for suportada
    const defaultLocation = [-23.5505, -46.6333]; 
    const map = L.map('map').setView(defaultLocation, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    L.marker(defaultLocation).addTo(map).bindPopup("Localiza√ß√£o padr√£o");
  }
}

// Chamar ambas as fun√ß√µes no carregamento
window.onload = function() {
  getGreeting();
  initMap();
};
</script>
{% endblock %}
