{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="corrida-detalhe-page">
  <h2>Detalhes da Corrida</h2>

  <div class="corrida-info">
    <p><strong>Motorista:</strong> {{ corrida.motorista.nome }}</p>
    <p><strong>Origem:</strong> {{ corrida.origem }}{% if corrida.bairro_origem %}, {{ corrida.bairro_origem }}{% endif %}, {{ corrida.cidade_origem }} - {{ corrida.estado_origem }}</p>
    <p><strong>Destino:</strong> {{ corrida.destino }}{% if corrida.bairro_destino %}, {{ corrida.bairro_destino }}{% endif %}, {{ corrida.cidade_destino }} - {{ corrida.estado_destino }}</p>
    <p><strong>Data:</strong> {{ corrida.data|date:"d/m/Y" }}</p>
    <p><strong>Horário de saída:</strong> {{ corrida.horario_saida|time:"H:i" }}</p>
    <p><strong>Horário estimado de chegada:</strong> {{ corrida.horario_chegada|time:"H:i" }}</p>
    <p><strong>Vagas disponíveis:</strong> {{ corrida.vagas_disponiveis }}</p>
    <p><strong>Valor:</strong> R$ {{ corrida.valor }}</p>
    {% if corrida.observacoes %}
      <p><strong>Observações:</strong> {{ corrida.observacoes }}</p>
    {% endif %}
    <p><strong>Status:</strong> {{ corrida.get_status_display }}</p>
  </div>

  {% if user == corrida.motorista %}
    <!-- Controles do motorista: Iniciar / Finalizar corrida -->
    <div class="corrida-controles">
      <form id="form-iniciar" action="{% url 'corrida:iniciar_corrida' corrida.id %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" id="btn-iniciar" class="btn"
                {% if corrida.status != 'ativa' %}disabled{% endif %}>
          Iniciar Corrida
        </button>
      </form>

      <form id="form-encerrar" action="{% url 'corrida:encerrar_corrida' corrida.id %}" method="post" style="display:inline; margin-left:8px;">
        {% csrf_token %}
        <button type="submit" id="btn-encerrar" class="btn btn-danger"
                {% if corrida.status != 'em_andamento' %}disabled{% endif %}>
          Finalizar Corrida
        </button>
      </form>
    </div>

    <h3>Solicitações de Carona</h3>
    <div class="solicitacoes-list">
      {% for s in corrida.solicitacoes.all %}
        <div class="solicitacao-item {% if s.status == 'PENDENTE' %}pendente{% elif s.status == 'ACEITA' %}aceita{% else %}outros{% endif %}"
             data-status="{{ s.status }}">
          <p><strong>Passageiro:</strong> {{ s.passageiro.nome }}</p>
          <p><strong>Status:</strong> {{ s.get_status_display }}</p>

          {% if s.status == 'PENDENTE' %}
            <button class="btn-aceitar"
                    data-corrida="{{ corrida.id }}"
                    data-solicitacao="{{ s.id }}">
              Aceitar Solicitação
            </button>
          {% endif %}
        </div>
      {% empty %}
        <p>Não há solicitações para esta corrida.</p>
      {% endfor %}
    </div>
  {% else %}
    <!-- Para outros usuários (passageiros) apenas lista de solicitações não aparece -->
    <h3>Informações</h3>
    <p>Somente o motorista pode controlar a corrida (iniciar / finalizar).</p>
  {% endif %}
</div>

<!-- confirmação JS para iniciar/encerrar -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const formIniciar = document.getElementById('form-iniciar');
  if (formIniciar) {
    formIniciar.addEventListener('submit', function(e) {
      if (!confirm('Confirma iniciar a corrida?')) e.preventDefault();
    });
  }
  const formEncerrar = document.getElementById('form-encerrar');
  if (formEncerrar) {
    formEncerrar.addEventListener('submit', function(e) {
      if (!confirm('Confirma encerrar a corrida?')) e.preventDefault();
    });
  }
});
</script>

<link rel="stylesheet" href="{% static 'corrida/css/detalhe_corrida.css' %}">
<script src="{% static 'corrida/js/aceitar_solicitacao.js' %}" defer></script>
{% endblock %}
