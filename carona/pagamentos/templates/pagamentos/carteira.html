{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'pagamentos/css/carteira.css' %}">
<script src="{% static 'pagamentos/js/carteira.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="carteira-container">
    <h1>Minha Carteira</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <p class="{{ message.tags }}">{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <div class="saldo-section">
        <span class="saldo-label">Saldo Atual:</span>
        <span class="saldo-value">R$ {{ carteira.saldo|floatformat:2 }}</span>
    </div>

    <div class="adicionar-saldo-section">
        <h2>Adicionar Saldo</h2>
        <form id="adicionar-saldo-form" method="POST" action="{% url 'pagamentos:adicionar_saldo' %}">
            {% csrf_token %}
            <input type="number" step="0.01" min="1" name="valor" placeholder="Valor em R$" required>
            <button type="submit">Adicionar</button>
        </form>
    </div>

    <div class="historico-section">
        <h2>Histórico de Pagamentos / Depósitos</h2>
        {% if pagamentos %}
        <table class="historico-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>Pagamento</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pagamentos %}
                <tr class="status-{{ p.status|lower }}">
                    <td>{{ p.id }}</td>
                    <td>{{ p.get_payment_type_display }}</td>
                    <td>{{ p.amount_display }}</td>
                    <td>{{ p.get_status_display }}</td>
                    <td>{{ p.created_at|date:"d/m/Y H:i" }}</td>
                    <td>
                        {% if p.status == "PENDING" %}
                            {% if p.billing_url %}
                                <a href="{{ p.billing_url }}" target="_blank" class="btn-pagar">Pagar / Ver QR</a>
                            {% else %}
                                <form method="POST" action="{% url 'pagamentos:refresh_qr' p.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-gerar">Gerar Pagamento</button>
                                </form>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Você ainda não realizou nenhum pagamento ou depósito.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
