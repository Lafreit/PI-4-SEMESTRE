{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="notif-page">

  <!-- Cabeçalho -->
  <div class="notif-header">
    <h2>Notificações</h2>
    <div id="notif-badge" class="notif-badge">Carregando...</div>
  </div>

  <!-- Lista de notificações -->
  <div id="notif-list" class="notif-list">
    {% for n in notificacoes %}
      <div class="notif-item {% if not n.lida %}nao-lida{% endif %}" data-id="{{ n.id }}"
           {% if n.dados_normalizados.corrida_id %} data-corrida="{{ n.dados_normalizados.corrida_id }}"{% endif %}>
        <div class="notif-main">
          <div class="notif-title">{{ n.titulo }}</div>
          <div class="notif-msg">{{ n.mensagem }}</div>

          {# ===== Pequenos dados úteis (aparecem apenas se existirem) ===== #}
          <div class="notif-dados" style="font-size:0.9rem;color:#555;margin-top:8px;">
            {% if n.dados_normalizados.corrida_id %}
              <div><strong>Corrida:</strong> {{ n.dados_normalizados.corrida_id }}</div>
            {% endif %}
            {% if n.dados_normalizados.solicitacao_id %}
              <div><strong>Solicitação:</strong> {{ n.dados_normalizados.solicitacao_id }}</div>
            {% endif %}
            {% if n.dados_normalizados.payment %}
              {# se n.dados_normalizados.payment for um objeto/dict com campos comuns #}
              {% if n.dados_normalizados.payment.amount_display %}
                <div><strong>Valor:</strong> {{ n.dados_normalizados.payment.amount_display }}</div>
              {% endif %}
              {% if n.dados_normalizados.payment.status %}
                <div><strong>Status pagamento:</strong> {{ n.dados_normalizados.payment.status }}</div>
              {% endif %}
            {% endif %}
          </div>
          {# ============================================================ #}

        </div>

        <div class="notif-meta">
          <div class="notif-time">{{ n.criada_em|date:"d/m/Y H:i" }}</div>

          {% if not n.lida %}
            <button class="btn-marcar-lida" data-id="{{ n.id }}">Marcar como lida</button>
          {% endif %}

          {# ===== Lógica para mostrar os botões na coluna meta ===== #}

          {# Mostrar Acompanhar & pagar apenas se: corrida existe, está em andamento e o título NÃO for "Solicitação Aceita" #}
          {% if n.corrida_exists and n.corrida_status == 'em_andamento' and n.titulo != "Solicitação Aceita" and request.user.tipo_usuario == 'passageiro' or request.user.tipo_usuario == 'admin' %}
            <button class="btn-acompanhamento"
                    data-corrida="{{ n.dados_normalizados.corrida_id }}"
                    data-notif="{{ n.id }}">
              Acompanhar & pagar
            </button>

          {# Se tiver corrida_id mas não cumprir a condição acima => mostrar link "Ver detalhes" #}
          {% elif n.dados_normalizados.corrida_id %}
            <a href="{% url 'corrida:detalhe' n.dados_normalizados.corrida_id %}" class="btn-detalhe">Ver detalhes</a>
          {% endif %}

          {# Caso específico: se for solicitação recebida e tiver solicitacao_id, mostra botão aceitar #}
          {% if n.tipo == n.TIPO_SOLICITACAO_RECEBIDA and n.dados_normalizados.solicitacao_id %}
            <button class="btn-aceitar" data-corrida="{{ n.dados_normalizados.corrida_id }}" data-solicitacao="{{ n.dados_normalizados.solicitacao_id }}">
              Aceitar solicitação
            </button>
          {% endif %}

                    
          {# NOVO: Se a solicitação já estiver aceita, mostrar botão cancelar #}
          {% if n.tipo == n.TIPO_SOLICITACAO_RECEBIDA and n.dados_normalizados.status == 'ACEITA' %}
            <button class="btn-cancelar-solicitacao"
                    data-corrida="{{ n.dados_normalizados.corrida_id }}"
                    data-solicitacao="{{ n.dados_normalizados.solicitacao_id }}">
                Cancelar solicitação
            </button>
          {% endif %}

        </div>
      </div>
    {% empty %}
      <p>Você não possui notificações.</p>
    {% endfor %}
  </div>

</div>

<!-- URLs e CSRF -->
<script>
  const URL_MARCAR_LIDA = "{% url 'notificacao:api_marcar_lida' %}";
  const URL_CONTAGEM = "{% url 'notificacao:api_contagem' %}";
  const URL_ACEITAR = "{% url 'corrida:api_aceitar_solicitacao' %}";
  const URL_ACOMP_BASE = "{% url 'corrida:acompanhamento' 0 %}"; // ex: /corrida/acompanhamento/0/
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>

<link rel="stylesheet" href="{% static 'notificacao/css/notificacoes.css' %}">
<script src="{% static 'notificacao/js/notificacoes.js' %}" defer></script>
{% endblock %}
